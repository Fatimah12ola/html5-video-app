name: Deploy Bicep

on:
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: 'Resource group name'
        required: true
        default: 'html5video-rg'
      location:
        description: 'Location'
        required: true
        default: 'eastus'
      storageAccountName:
        description: 'Storage account name (optional)'
        required: false
      cosmosDbAccountName:
        description: 'Cosmos DB account name (optional)'
        required: false

jobs:
  bicep-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure CLI extensions
        run: az extension add --name bicep || true

      - name: Deploy Bicep template
        env:
          RESOURCE_GROUP: ${{ github.event.inputs.resourceGroup }}
          LOCATION: ${{ github.event.inputs.location }}
          STORAGE_ACCOUNT_NAME: ${{ github.event.inputs.storageAccountName }}
          COSMOSDB_ACCOUNT_NAME: ${{ github.event.inputs.cosmosDbAccountName }}
        run: |
          ./scripts/deploy-bicep.sh

      - name: Show outputs
        run: az deployment group show --resource-group ${{ github.event.inputs.resourceGroup }} --name html5video-$(date +%s) --query properties.outputs -o json || echo 'Check deployment outputs in the portal'
